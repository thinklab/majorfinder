<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Major Finder — Outcomes Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px; max-width: 1200px; margin: auto; padding: 20px;}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center;margin-bottom:20px}
    .controls-group { display: flex; align-items: center; gap: 8px; background: #f0f0f0; padding: 5px 15px; border-radius: 20px; border: 1px solid #ddd;}
    .controls-group label { font-size: 0.9rem; font-weight: bold; color: #555;}
    select{padding:8px 12px; min-width: 300px; border-radius: 4px; border: 1px solid #ccc;}
    #chart, #rpy-chart{width:100%;height:500px; background: #f9f9f9; border-radius: 8px; margin-bottom: 20px;}
    #rpy-chart { height: 300px; }
    .stats-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;}
    .stat-card { background: #eee; padding: 10px 15px; border-radius: 8px; flex: 1; min-width: 150px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
    .stat-card h3 { margin: 0 0 10px 0; font-size: 0.9rem; color: #555; text-transform: uppercase; display: flex; align-items: center; gap: 5px;}
    .stat-card .value { font-size: 1.5rem; font-weight: bold;}
    .info-icon { 
      display: inline-flex; align-items: center; justify-content: center;
      width: 16px; height: 16px; border-radius: 50%; background: #ccc; 
      color: #fff; font-size: 10px; cursor: help; font-weight: bold;
    }
    .tooltip { position: relative; display: inline-block; }
    .tooltip .tooltiptext {
      visibility: hidden; width: 200px; background-color: #555; color: #fff;
      text-align: center; border-radius: 6px; padding: 10px; position: absolute;
      z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0;
      transition: opacity 0.3s; font-size: 0.8rem; text-transform: none; font-weight: normal;
    }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    .note{color:#777;font-size:0.9rem; margin-top: 20px;}
    [data-theme="dark"] .stat-card { background: #333; }
    [data-theme="dark"] .stat-card h3 { color: #aaa; }
    h1 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 30px;}
  </style>
</head>
<body>
  <h1>College Major Outcomes Dashboard</h1>
  
  <div class="row">
    <label>Select Major Group:
      <select id="major-group"></select>
    </label>
    <label>Select Subgroup Major:
      <select id="major"></select>
    </label>
    <label>Degree Level (CREDLEV):
      <select id="cred"></select>
    </label>
  </div>

  <div class="stats-container">
    <div class="stat-card">
        <h3>Median Debt</h3>
        <div id="stat-debt" class="value">---</div>
    </div>
    <div class="stat-card">
        <h3>Repayment Rate (3-Year)</h3>
        <div id="stat-rpy" class="value">---</div>
    </div>
    <div class="stat-card">
        <h3>Median Earn (1-Year)</h3>
        <div id="stat-earn" class="value">---</div>
    </div>
    <div class="stat-card">
        <h3>
          Earnings-to-Debt Ratio
          <span class="tooltip">
            <span class="info-icon">i</span>
            <span class="tooltiptext">How many dollars you earn in your first year for every dollar of student debt. Higher is better.</span>
          </span>
        </h3>
        <div id="stat-ratio" class="value">---</div>
    </div>
    <div class="stat-card">
        <h3>Avg Annual Cost</h3>
        <div id="stat-cost" class="value">---</div>
    </div>
  </div>

  <div id="chart"></div>
  <div id="rpy-chart"></div>
  
  <p class="note">
    <b>Scoreboard update:</b> November 17, 2025.
    <br>
    <b>Data Note:</b> Earnings distribution shows the frequency of median earnings across different institutions for the selected major. 
    Percentile lines: p10, p25, median (red), p75, p90.
    <br>
    <b>Degree Levels (CREDLEV):</b> 1: Certificate, 2: Associate's, 3: Bachelor's, 4: Post-baccalaureate, 5: Master's, 6: Doctoral, 7: First Professional, 8: Graduate Certificate.
    <br><a href="about.html">Learn more about the data and processing</a>.
  </p>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let DATA = { majors: [], credlevs: [], payload: {} };

  async function loadData() {
    const res = await fetch('data.json', { cache: 'no-store' });
    if (!res.ok) throw new Error(`Failed to load data.json: ${res.status}`);
    DATA = await res.json();
  }

  function getMajorData(majorName) {
    return DATA.payload[majorName] || null;
  }

  function populateSelectors() {
    const groupSel = document.getElementById('major-group');
    const majorSel = document.getElementById('major');
    const credSel  = document.getElementById('cred');

    groupSel.innerHTML = '';
    majorSel.innerHTML = '';
    credSel.innerHTML = '<option value="__ALL__">All Levels</option>';

    const groups = DATA.groups || {};
    const groupNames = Object.keys(groups);

    groupNames.forEach(g => {
      const o = document.createElement('option');
      o.value = g; o.text = g;
      groupSel.add(o);
    });

    function updateMajors() {
      const group = groupSel.value;
      const majors = groups[group] || [];
      majorSel.innerHTML = '<option value="__GROUP_SUMMARY__">-- Summary (All in Group) --</option>';
      majors.forEach(m => {
        const o = document.createElement('option');
        o.value = m; o.text = m;
        majorSel.add(o);
      });
      updateCreds();
    }

    function updateCreds() {
      const groupName = groupSel.value;
      const mName = majorSel.value;
      
      let mData;
      if (mName === '__GROUP_SUMMARY__') {
        mData = (DATA.group_payloads || {})[groupName] || {};
      } else {
        mData = DATA.payload[mName] || {};
      }
      
      const currentCred = credSel.value;
      
      credSel.innerHTML = '<option value="__ALL__">All Levels</option>';
      
      // Cred levels are numbers in the payload keys
      const availableCreds = Object.keys(mData).filter(k => k !== '__ALL__');
      
      const names = {
        1: 'Undergraduate Certificate',
        2: 'Associate\'s Degree',
        3: 'Bachelor\'s Degree',
        4: 'Post-baccalaureate Certificate',
        5: 'Master\'s Degree',
        6: 'Doctoral Degree',
        7: 'First Professional Degree',
        8: 'Graduate/Professional Certificate'
      };

      availableCreds.sort((a,b) => Number(a) - Number(b)).forEach(c => {
        const o = document.createElement('option');
        o.value = String(c);
        o.text = names[c] ? `${names[c]} (Level ${c})` : `Level ${c}`;
        credSel.add(o);
      });

      if (availableCreds.includes(currentCred)) {
        credSel.value = currentCred;
      } else {
        credSel.value = '__ALL__';
      }
      updateChart();
    }

    function updateChart() {
      render();
    }

    groupSel.onchange = updateMajors;
    majorSel.onchange = updateCreds;
    credSel.onchange = updateChart;

    if (groupNames.length) {
      groupSel.value = groupNames[0];
      updateMajors();
    }
  }

  async function render() {
    const groupSel = document.getElementById('major-group');
    const majorSel = document.getElementById('major');
    const credSel  = document.getElementById('cred');
    
    const g = groupSel.value;
    const m = majorSel.value;
    const credVal = credSel.value;
    
    let majorPayloads;
    if (m === '__GROUP_SUMMARY__') {
      majorPayloads = (DATA.group_payloads || {})[g] || null;
    } else {
      majorPayloads = DATA.payload[m] || null;
    }
    
    const payload = (majorPayloads || {})[credVal === '__ALL__' ? '__ALL__' : Number(credVal)] || null;

    const view = (payload && payload['all']) ? payload['all'] : null;

    if (!payload || !view) {
      document.getElementById('stat-debt').innerText = 'N/A';
      document.getElementById('stat-rpy').innerText = 'N/A';
      document.getElementById('stat-earn').innerText = 'N/A';
      document.getElementById('stat-ratio').innerText = 'N/A';
      document.getElementById('stat-cost').innerText = 'N/A';
      Plotly.newPlot('chart', [], {title: 'No data for this selection'});
      Plotly.newPlot('rpy-chart', [], {title: 'No repayment data'});
      return;
    }

    // Update Cards
    document.getElementById('stat-debt').innerText = view.debt_mdn ? '$' + view.debt_mdn.toLocaleString() : 'N/A';
    document.getElementById('stat-rpy').innerText = payload.rpy_3yr_rt ? (payload.rpy_3yr_rt * 100).toFixed(1) + '%' : 'N/A';
    document.getElementById('stat-earn').innerText = (view.earn_pcts && view.earn_pcts.p50) ? '$' + view.earn_pcts.p50.toLocaleString() : 'N/A';
    document.getElementById('stat-ratio').innerText = view.earn_to_debt_ratio ? view.earn_to_debt_ratio.toFixed(2) : 'N/A';
    document.getElementById('stat-cost').innerText = payload.cost_avg ? '$' + payload.cost_avg.toLocaleString() : 'N/A';

    // Update Chart
    const bins = view.earn_bins || [];
    const p = view.earn_pcts || {};
    
    if (bins.length === 0) {
        Plotly.newPlot('chart', [], {title: 'No earnings distribution data'});
        return;
    }

    const x0 = bins.map(b => b.x0);
    const x1 = bins.map(b => b.x1);
    const y  = bins.map(b => b.count);
    const widths = x1.map((v,i) => Math.max((v - x0[i]), 1e-6));
    const ymax = Math.max(...y, 1);

    const barTrace = {
      type: 'bar',
      x: x0,
      y: y,
      width: widths,
      marker: {color: 'rgba(31,120,180,0.85)'},
      hovertemplate: 'Range: %{x:.0f} – %{customdata:.0f}<br>Count: %{y}<extra></extra>',
      customdata: x1
    };

    const pctDefs = [
      {k:'p10', color:'#888', dash:'dot'},
      {k:'p25', color:'#888', dash:'dot'},
      {k:'p50', color:'crimson', dash:'solid'},
      {k:'p75', color:'#888', dash:'dot'},
      {k:'p90', color:'#888', dash:'dot'},
    ].filter(d => p[d.k] != null);

    const shapes = pctDefs.map(d => ({
      type:'line', x0:p[d.k], x1:p[d.k], y0:0, y1:ymax,
      line:{color:d.color, width:2, dash:d.dash}
    }));

    const annotations = pctDefs.map(d => ({
      x:p[d.k], y:ymax, xanchor:'left', yanchor:'bottom',
      text:d.k, showarrow:false, font:{color:d.color}
    }));

    const layout = {
      title: `${m === '__GROUP_SUMMARY__' ? g + ' (Group Summary)' : m} - Earnings Distribution`,
      bargap: 0.01,
      xaxis: {title:'Median Earnings ($)'},
      yaxis: {title:'Number of Institutions'},
      shapes, annotations,
      margin: {l:60,r:20,t:60,b:60},
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)'
    };

    Plotly.newPlot('chart', [barTrace], layout, {displayModeBar:true, responsive:true});

    // Update Repayment Chart
    const rpyTraces = [];
    ['rpy1', 'rpy4'].forEach((key, idx) => {
        const rData = payload[key];
        if (!rData) return;
        const d = rData.dist;
        const x = [idx === 0 ? '1-Year' : '4-Year'];
        
        rpyTraces.push({
            name: 'Paid / Progress',
            type: 'bar', x: x, y: [d.paid_prog * 100], orientation: 'v',
            marker: {color: '#2ca02c'}, showlegend: idx === 0
        });
        rpyTraces.push({
            name: 'Other / Waiting',
            type: 'bar', x: x, y: [d.other * 100], orientation: 'v',
            marker: {color: '#ffbb78'}, showlegend: idx === 0
        });
        rpyTraces.push({
            name: 'Default / Delinq',
            type: 'bar', x: x, y: [d.default_delinq * 100], orientation: 'v',
            marker: {color: '#d62728'}, showlegend: idx === 0
        });
    });

    const rpyLayout = {
      title: 'Repayment Status (1-Year vs 4-Year)',
      barmode: 'stack',
      yaxis: {title: 'Percentage (%)', range: [0, 100]},
      xaxis: {title: 'Cohort Year'},
      margin: {l:60,r:20,t:60,b:60},
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      height: 300
    };

    if (rpyTraces.length > 0) {
        // Group traces by name to avoid legend duplication
        const groupedTraces = {};
        rpyTraces.forEach(t => {
            if(!groupedTraces[t.name]) groupedTraces[t.name] = { ...t, x: [], y: [] };
            groupedTraces[t.name].x.push(t.x[0]);
            groupedTraces[t.name].y.push(t.y[0]);
        });
        Plotly.newPlot('rpy-chart', Object.values(groupedTraces), rpyLayout, {responsive:true});
    } else {
        Plotly.newPlot('rpy-chart', [], {title: 'No repayment breakdown data'});
    }
  }

  document.getElementById('major').addEventListener('change', render);
  document.getElementById('cred').addEventListener('change', render);

  (async () => {
    try {
      await loadData();
      populateSelectors();
      render();
    } catch (e) {
      console.error(e);
      document.getElementById('chart').innerHTML = '<div style="padding:20px;">Could not load data. Ensure "python scripts/generate_site_data.py" has been run and "docs/data.json" exists.</div>';
    }
  })();
});
</script>
</body>
</html>
